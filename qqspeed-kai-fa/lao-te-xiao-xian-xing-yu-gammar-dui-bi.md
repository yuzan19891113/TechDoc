# 老特效线性与Gammar对比

![](../.gitbook/assets/image%20%2811%29.png)

**EffectsRTAnalyzer，EffectsToRT：**

1. 进入编辑器Playing状态，2个相机，gamma, linear,同一帧模拟数据，不同的RT,
2. 挂在主相机的后处理，几次Blit将线性的结果转为gamma,然后转LAB空间 操作，按照需求显示在屏幕
3.  回读结果分析，得到单帧数据
4.  特效帧更新，特效播放结束换相机方向（前后，上下，左右相机）重新开始，

Lab：感知均匀，L分量：亮度， A, 红到绿的比例 B蓝到黄比例，对比颜色空间，从rgb-&gt;hsv-&gt;lab

**数据处理：**

首先剔除掉数值变化较小的像素，避免小数淹没大数，

结果处理方法:

![](../.gitbook/assets/image%20%2818%29.png)



* 得到每帧LAB差异总量，差异均值，6组数据
* 取相机前，上，左的每帧结果数据的Max

目录：Assets/ResForAssetBundles/Effects; Assets/ArtWork/Effects，

总的Prefab 个数 34150， 去掉纯引用的Prefab：还有20949

阈值：基本还是经验值，没法说用一个科学的方法来评估，但要往尽量科学靠，现在的都是自己根据强哥最开始给的一版数据自己设定的。

```text
           //对于变化面积小且平均变化还能接受的特效
           Vector3 LabTotalParam1 = new Vector3(10, 2.5f, 2.5f);
           Vector3 LabAVGParam1 = new Vector3(0.14f, 0.03f, 0.03f);
           
           //对于平均变化比较小且变化面积不大的特效
           Vector3 LabAVGParam2 = new Vector3(0.07f, 0.015f, 0.015f);
           Vector3 LabTotalParam2 = new Vector3(500, 100f, 100f);
```

使用256 \* 256来作为计算和分析rt，**为啥选用256 \* 256**

基本上呈现一种scale的差异，分辨率对均值影响不大，并且256 \*256是现在唯一有8,9帧的。

![](../.gitbook/assets/image%20%2820%29.png)

![](../.gitbook/assets/image%20%2841%29.png)

![](../.gitbook/assets/image%20%2825%29.png)

目标：**输出安全的特效保证结果正确，输出最有问题的特效来给美术修改**

给美术提供gamma和线性下的结果

数据对比分析，显示结果与数据对比

![Linear](../.gitbook/assets/image%20%2812%29.png)

![Diff\_L](../.gitbook/assets/image%20%2823%29.png)

![Diff\_A](../.gitbook/assets/image%20%2834%29.png)

![](../.gitbook/assets/image%20%2831%29.png)

![](../.gitbook/assets/image%20%2829%29.png)

**图中总值110 &gt;阈值100， B均值0.022大于0.015，标记为需要修改的特效**

能通过的特效：

![Gamma](../.gitbook/assets/image%20%2833%29.png)

![ Linear](../.gitbook/assets/image%20%2813%29.png)

![](../.gitbook/assets/image%20%2840%29.png)



**初步的一些结论：**

1. 强哥给的特效都能判断出来，单向的验证，坏的特效一定不能通过验证，

   2 初步的小规模测试结果：刚测的FX\_Pet目录，总数3363，跑完到17.69%， 测试数量595， good数量是206， miss数量31\(待查,特效可能未播出来或其他原因未显示在镜头吧\)，大概能不改的比例为34.7%，前天测过一次更大规模的，大概跑了10000多个，有5000多个是安全的，不过这是avatar里的特效里的，估计大部分是小特效，其他pet里抽的子文件大概为30-40%左右，希望星期天跑一下能得到个全量数据看一下。还没有全量，因为现在速度太慢，一个得3-6秒。20000多个就得十几万秒

**初步结论：大概有30%-50%的不需要修改，小特效会接近50%，**

存在的问题：

1移动较快或者并且本身就有亮度或者颜色的变化，就会造成单帧差异大，数据可能表现差异大，整体不明显，

2 效果变好了，没法感知，现在只是能够整体接受变亮一些,但是我们接受的美术能否接受

3 基本上大部分大特效都会标注为要修改，因为，不仅变化大，而且可能总量大，这个好像没法避免，

思考和计划：

* 给美术提供我的数据来验证我得到结论安全的特效美术也认为可以，**双向验证**
* 同时能够出一个最差的一批特效优先改
* 趁着星期天出一个全量测试看一下有多少特效可以不改，
* 是否可以策划或者美术，运营给个优先级，按照优先级来设定不同的要求，重要的特效容差度低点
* 需要加速，每个特效现在需要6s，并且运行帧率只有9帧
* 是否需要提供美术工具快速对比特效差异，现在估计美术挺慢的
* 数据阈值选取能否更加科学

其他一些问题：

我们的lod不是自动的，而是不同的资源，是否会增加包量

改进方法：

1 为了避免反复分析数据消耗大量时间，也为了保存每个版本结果，直接增加一个数据库的类fxDataCache,  cache数据分析结果，包括分析的直接数据，判断的结果（通过，待修改），从而既可以随时增量分析，随时修改参数也不用重新分析，并且数据库能够支持人工检视。

2 通过分析结果反复迭代阈值，例如通过对错误分类的特效分析，结论是加入更多的阈值以区分不同大小的特效，而不是直接scale阈值，scale阈值通过率是上升了（低优先级1.5倍-&gt;55%, 低优先级2倍，高优先级1.5倍-&gt;76%，但是出现了大量被错误标记通过

第一次全量结果：两组阈值，特效通过率百分之40%，基本无风险

![](../.gitbook/assets/image%20%2858%29.png)

增加中特效阈值，扩大小特效阈值，第二次分析结果

![](../.gitbook/assets/image%20%2850%29.png)

![](../.gitbook/assets/image%20%2866%29.png)

低优先级特效扩大阈值

2 提供美术工具快速对比差异

万分之一概率上报，

android:总共出现16751个特效，

| 5583 | 5583 | 5584（高优先级） |
| :--- | :--- | :--- |
| &lt;85 \* 10000 | &lt;553 \* 10000 | （553-18673） \* 10000 |

1/3段：0-85；85-553; 553- 18763,对应优先级0,1,2

希望让美术花1天过安全特效（可以过得比较快），再一天过待修改特效，生成数据结果，然后再根据优先级排序导出

安全特效 = 数据分析安全 + 人工快速过安全

待修改特效 = 数据分析待修改 + 人工确认待修改

![](../.gitbook/assets/image%20%2855%29.png)

特效整理lod后-&gt;1900

特效整理分组后，按照package分组

| 资源类型 | 资源文件夹 | 资源复杂程度 | 预估用时/分钟 | 预估平均工时 |  |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 赛车 | 普通A普通B | FX\_Car\_Private | 2 | 20 | 0.04 |
| A车带车身特效 | FX\_Car\_Private | 3 | 30 | 0.06 |  |
| A车 魔法赛车 | FX\_Car\_Private/FX\_Car\_Magic | 5 | 50 | 0.10 |  |
| 宠物 | 普通B宠物 | FX\_Pet | 4 | 40 | 0.08 |
| A宠物普通 | FX\_Pet | 5 | 50 | 0.10 |  |
| A宠物带场景 | FX\_Pet | 6 | 60 | 0.13 |  |
| 套装 | 普通极品套装 | FX\_AvatarNormal | 2 | 20 | 0.04 |
| 动作套装 | FX\_AvatarNormal | 4 | 40 | 0.08 |  |
| 魔法套装含场景 | FX\_AvatarNormal/FX\_AvatarMagic | 9 | 90 | 0.19 |  |
| 挂件 | 戒指 | FX\_AvtHead | 1 | 10 | 0.02 |
| 翅膀 | FX\_AvtWing | 1 | 10 | 0.02 |  |
| 手杖 | FX\_AvtHand | 1 | 10 | 0.02 |  |
| 装饰 | 飞饰 | FX\_FlyDecoration | 5 | 50 | 0.10 |
| 脚底炫光 | FX\_AvtGlow | 3 | 30 | 0.06 |  |
| 光戒 | FX\_AvtHandRing | 5 | 50 | 0.10 |  |

1900-&gt;859

考虑到特效标准美术背景在飞车都偏亮， 综合考虑特效所处背景，以较小的阈值再分析一波。

bg 128,128,128 ， l 0.03, a,0.01, b 0.01再刷一波

859-&gt;656  avatar :367

unity 的材质color会在线性空间下，自动转为线性color,  特效的color不会转线性。

特效材质共享数据：

default-diffuse, default-particle不能被修改，从而不需考虑多个外包修改的兼容问题



问题特效

![](../.gitbook/assets/image%20%28106%29.png)



